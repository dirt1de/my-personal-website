---
title: Data analysis on "Friends"
author: Xuxin Zhang
date: '2020-09-16'
slug: data-analysis-on-friends
categories:
  - R project
tags:
  - text mining
  - tidymodel
  - sentiment analysis
  - data visualization
subtitle: ''
summary: ''
authors: []
lastmod: '2020-09-16T16:06:34+08:00'
featured: no
image:
  caption: ''
  focal_point: ''
  preview_only: no
projects: []
---
![](/media/friends.jpg)

```{r,message=FALSE,warning = FALSE}
library(tidyverse)
library(tidymodels)
library(plotly)
theme_set(theme_classic())
friends <- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2020/2020-09-08/friends.csv')
friends_emotions <- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2020/2020-09-08/friends_emotions.csv')
friends_info <- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2020/2020-09-08/friends_info.csv')
```

```{r}
library(stringr)
remove<-"The One with|The One Where"
title_clean<-stringr::str_remove_all(friends_info$title,remove)

friends_info%>%mutate(epi_num = row_number())%>%
  ggplot(aes(x = epi_num, y = imdb_rating ))+
  geom_point(aes(color = as.factor(season),size = us_views_millions))+
  geom_path(aes(color = as.factor(season)))+
  expand_limits(x = -60)+
  expand_limits(x = 230)+
  geom_text(label = title_clean,hjust = 1,check_overlap = TRUE,size = 2.5)+
  theme(legend.position = "null")+geom_smooth()
```

```{r}
friends_info%>%
  ggplot(aes(x = us_views_millions, y = imdb_rating))+
  geom_point()+geom_smooth()
```


```{r}
library(ggridges)
friends_info%>%mutate(season = as.factor(season))%>%
  ggplot(aes(y  = imdb_rating, x = season,fill = season))+
  geom_boxplot(alpha  = 0.6)+
  geom_smooth(aes(group = 1), se = FALSE)
```

We can find out the best 15 episodes as well as the worst 15 episodes.
```{r}
ggplotly(friends_info%>%distinct(title,imdb_rating,season)%>%
  top_n(15,imdb_rating)%>%
  ggplot(aes(x = imdb_rating,
             y = reorder(title, imdb_rating),
             color = as.factor(season)))+
  geom_point(size = 3)+geom_segment(aes(x = 9.0,
                                        xend = imdb_rating,
                                        y = title, 
                                        yend = title),
                                        size = 1.5,
                                    alpha = 0.5))
```


```{r}
ggplotly(friends_info%>%distinct(title,imdb_rating,season)%>%
  top_n(-15,imdb_rating)%>%
  ggplot(aes(x = imdb_rating,
             y = reorder(title, imdb_rating),
             color = as.factor(season)))+
  geom_point(size = 3)+geom_segment(aes(x = 9.0, xend = imdb_rating, y = title, yend = title),size = 1.5,alpha = 0.5))
```



```{r}
friends%>%count(speaker)%>%
  filter(speaker!="NA")%>%
  filter(n>120)%>%arrange(desc(n))%>%
  ggplot(aes(y = reorder(speaker,n), x = n))+
  geom_col(fill = "lightgreen")+scale_x_log10()
```

```{r}
library(tidytext)
friends%>%select(-text)%>%right_join(friends_emotions)%>%
    count(speaker, emotion)%>%add_count(speaker,name = "num")%>%
    filter(speaker!="NA")%>%
    filter(num>50)%>%
    mutate(average_emo = n/num)%>%
    group_by(emotion)%>%top_n(6,average_emo)%>%
    ggplot(aes(y = reorder_within(speaker,average_emo,emotion), 
               x = average_emo, 
               color = emotion))+
    geom_point(size = 2.5)+
    geom_segment(aes(x = 0,xend = average_emo,
                     y = reorder_within(speaker,average_emo,emotion), 
                     yend = reorder_within(speaker,average_emo,emotion)),size = 1.5,alpha = 0.7)+
    facet_wrap(~emotion,scales = "free")+scale_y_reordered()+
    theme(legend.position = "null")+
    labs(x = "Average emotion level",
         y = "Characters",
         title = "Character rankings in different types of emotion")
```


```{r}

text<-friends_info%>%mutate(epi_num = row_number())%>%
  select(season,episode,title,epi_num)%>%
  right_join(friends, by = c("season" = "season", "episode" = "episode"))%>%distinct(season,epi_num,title,text)

text%>%
  unnest_tokens(word,text)%>%
  anti_join(stop_words)%>%inner_join(get_sentiments("afinn"))%>%
  group_by(season,epi_num,title)%>%
  summarise(sent = sum(value))%>%ungroup()%>%ggplot(aes(x = epi_num, y = sent))+
  geom_point(aes(color = as.factor(season)))+geom_line(aes(color = as.factor(season)))+geom_text(aes(label = title_clean),check_overlap = TRUE,size = 2)+
  geom_smooth()+
  scale_color_brewer(palette = "Paired")+theme(legend.position = "null")+
  expand_limits(x = -10)
```


```{r}
friends_rating <- friends_info%>%select(title,imdb_rating)

text%>%
  unnest_tokens(word,text)%>%
  anti_join(stop_words)%>%inner_join(get_sentiments("afinn"))%>%
  group_by(season,epi_num,title)%>%
  summarise(sent = sum(value))%>%ungroup()%>%left_join(friends_rating)%>%
  ggplot(aes(x = sent, y = imdb_rating))+geom_point()+geom_smooth()
```


```{r}
library(tidylo)

friends%>%
  select(speaker, text)%>%unnest_tokens(word, text)%>%
  anti_join(stop_words)%>%count(speaker,word)%>%add_count(speaker)%>%
  filter(nn>7000)%>%filter(speaker!="Scene Directions")%>%
  add_count(word)%>%
  filter(nnn > 50)%>%
  bind_log_odds(speaker,word,n)%>%
  group_by(speaker)%>%
  top_n(10,log_odds_weighted)%>%
  ggplot(aes(x = log_odds_weighted, 
             y = reorder_within(word, log_odds_weighted, speaker), 
             fill = speaker))+
  geom_col()+facet_wrap(~speaker, scales = "free_y")+scale_y_reordered()+
  scale_fill_brewer(palette = "Paired")
  
```


```{r}
friends_speak<-friends%>%count(speaker,season,episode)%>%
  add_count(speaker,name = "total_speak")%>%
  add_count(season,episode,name = "total_speak_per_ep")%>%
  filter(total_speak>7000)%>%select(-total_speak)%>%mutate(prop_line = n/total_speak_per_ep)%>%
  select(-n,-total_speak_per_ep)

friends_info%>%select(season,episode,imdb_rating)%>%
  inner_join(friends_speak,by = c("season","episode"))%>%
  ggplot(aes(x = prop_line, y = imdb_rating, color = speaker))+
  geom_point(alpha = 0.5)+facet_wrap(~speaker)+scale_x_log10()+geom_smooth()
  
```



```{r}
friends_actors<-friends%>%
  select(season, episode,speaker)%>%
  count(season, episode,speaker)%>%add_count(speaker)%>%
  filter(nn>=150)%>%
  filter(speaker!="NA")%>%
  filter(speaker!="Scene Directions")%>%
  select(-nn)%>%
  group_by(season, episode)%>%
  pivot_wider(names_from = speaker, values_from = n, values_fill = 0)

friends_actors
```

Notice the difference in row number. Why is that? 
We have filtered out some of the directors and writers. 

```{r}
friends_creators<-friends_info%>%select(season, episode, directed_by,written_by,imdb_rating)%>%
  mutate(written_by = str_replace(written_by,"Teleplay by :"," &"))%>%
  mutate(written_by = str_remove(written_by,"Story by :"))%>%
  separate_rows(written_by,sep ="&")%>%
  pivot_longer(directed_by:written_by,names_to = "position",values_to = "name")%>%
  distinct(season,episode,imdb_rating,position,name)%>%
  add_count(name)%>%filter(n>=12)%>%
  select(-position,-n)%>%
  mutate(count = 1)%>%group_by(season,episode, imdb_rating)%>%
  pivot_wider(names_from = name, values_from = count, values_fill = 0)

friends_creators
```

```{r}
friends_staff<-friends_actors%>%inner_join(friends_creators,by = c("season","episode"))%>%
  inner_join(friends_info%>%select(season,episode, title), by= c("season","episode"))

friends_staff
```

```{r}
set.seed(123)
friends_split<-initial_split(friends_staff,strata = season)
friends_train <- training(friends_split)
friends_test <- testing(friends_split)

friends_boot <- bootstraps(friends_train,strata = season)
```


```{r}
friends_recipe<-recipe(imdb_rating~., data =  friends_train)%>%
  update_role(title, new_role = "ID")%>%
  step_normalize(all_predictors())%>%
  step_zv(all_predictors())%>%
  step_corr(all_predictors())

prep(friends_recipe)%>%juice()
```



```{r}
library(vip)
set.seed(234)
friends_lasso<-linear_reg(penalty = 0.001, mixture=1)%>%set_engine("glmnet")

workflow()%>%add_recipe(friends_recipe)%>%add_model(friends_lasso)%>%
  fit(data = friends_train)%>%pull_workflow_fit()%>%tidy()%>%arrange(desc(estimate))
```

```{r,warning=FALSE}
set.seed(2020)
tune_model <-linear_reg(penalty = tune(), mixture=1)%>%
  set_engine("glmnet")

lambda <- grid_regular(penalty(),levels = 50)

tuned_lasso<-tune_grid(workflow()%>%add_recipe(friends_recipe)%>%add_model(tune_model),
          resamples = friends_boot,
          grid = lambda)

tuned_lasso%>%collect_metrics()%>%
  ggplot(aes(x = penalty, y = mean, color = .metric))+
  geom_point()+geom_path()+facet_wrap(~.metric,scales = "free",ncol = 1)+
  scale_x_log10()
```

```{r}
best_penalty<-tuned_lasso%>%select_best("rmse")

final_workflow<-finalize_workflow(workflow()%>%
                                    add_recipe(friends_recipe)%>%
                                    add_model(tune_model), 
                                  best_penalty)
```


```{r}
set.seed(4321)
final_workflow%>%fit(data = friends_train)%>%
  pull_workflow_fit()%>%
  vi(lamda = best_penalty$penalty)%>%
  mutate(Importance = abs(Importance))%>%
  ggplot(aes(x = Importance, y = reorder(Variable, Importance), fill = Sign))+
  geom_col()
```





